import{$ as V,A as z,B as Z,a as G,E as W,G as Y}from"./index-Ch0y_Xfo.js";import{r as f,c as K,d as x,w as J,p as D,h as n,b as N,F as Q}from"./purify.es-CuyYui_p.js";let X=e=>crypto.getRandomValues(new Uint8Array(e)),ee=(e,t,r)=>{let l=(2<<Math.log2(e.length-1))-1,c=-~(1.6*l*t/e.length);return(s=t)=>{let d="";for(;;){let g=r(c),y=c|0;for(;y--;)if(d+=e[g[y]&l]||"",d.length>=s)return d}}},te=(e,t=21)=>ee(e,t|0,X);var re=Object.defineProperty,A=Object.getOwnPropertySymbols,ae=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable,S=(e,t,r)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ne=(e,t)=>{for(var r in t||(t={}))ae.call(t,r)&&S(e,r,t[r]);if(A)for(var r of A(t))oe.call(t,r)&&S(e,r,t[r]);return e};function C(e,t){return Object.assign(e,{meta:ne({package:"@milkdown/components"},t)}),e}const ie={imageIcon:()=>"ðŸŒŒ",captionIcon:()=>"ðŸ’¬",uploadButton:()=>"Upload file",confirmButton:()=>"Confirm âŽ",uploadPlaceholderText:"or paste the image link ...",captionPlaceholderText:"Image caption",onUpload:e=>Promise.resolve(URL.createObjectURL(e))},j=V(ie,"imageBlockConfigCtx");C(j,{displayName:"Config<image-block>",group:"ImageBlock"});function le(e){return Y(e,"paragraph",(t,r,l)=>{var c,s;if(((c=t.children)==null?void 0:c.length)!==1)return;const d=(s=t.children)==null?void 0:s[0];if(!d||d.type!=="image")return;const{url:g,alt:y,title:b}=d,m={type:"image-block",url:g,alt:y,title:b};l.children.splice(r,1,m)})}const L=z("remark-image-block",()=>()=>le);C(L.plugin,{displayName:"Remark<remarkImageBlock>",group:"ImageBlock"});C(L.options,{displayName:"RemarkConfig<remarkImageBlock>",group:"ImageBlock"});var ce=Object.defineProperty,R=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,pe=(e,t)=>{for(var r in t||(t={}))se.call(t,r)&&T(e,r,t[r]);if(R)for(var r of R(t))ue.call(t,r)&&T(e,r,t[r]);return e};const q="image-block",E=Z("image-block",()=>({inline:!1,group:"block",selectable:!0,draggable:!0,isolating:!0,marks:"",atom:!0,priority:100,attrs:{src:{default:"",validate:"string"},caption:{default:"",validate:"string"},ratio:{default:1,validate:"number"}},parseDOM:[{tag:`img[data-type="${q}"]`,getAttrs:e=>{var t;if(!(e instanceof HTMLElement))throw W(e);return{src:e.getAttribute("src")||"",caption:e.getAttribute("caption")||"",ratio:Number((t=e.getAttribute("ratio"))!=null?t:1)}}}],toDOM:e=>["img",pe({"data-type":q},e.attrs)],parseMarkdown:{match:({type:e})=>e==="image-block",runner:(e,t,r)=>{const l=t.url,c=t.title;let s=Number(t.alt||1);(Number.isNaN(s)||s===0)&&(s=1),e.addNode(r,{src:l,caption:c,ratio:s})}},toMarkdown:{match:e=>e.type.name==="image-block",runner:(e,t)=>{e.openNode("paragraph"),e.addNode("image",void 0,void 0,{title:t.attrs.caption,url:t.attrs.src,alt:`${Number.parseFloat(t.attrs.ratio).toFixed(2)}`}),e.closeNode()}}}));C(E.node,{displayName:"NodeSchema<image-block>",group:"ImageBlock"});function B({icon:e,class:t,onClick:r}){return n("span",{class:N("milkdown-icon",t),onPointerdown:r,ref:l=>{l&&e&&(l.innerHTML=D.sanitize(e.trim()))}})}B.props={icon:{type:String,required:!1},class:{type:String,required:!1},onClick:{type:Function,required:!1}};const de=te("abcdefg",8),ge=x({props:{src:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setLink:{type:Function,required:!0},imageIcon:{type:String,required:!1},uploadButton:{type:String,required:!1},confirmButton:{type:String,required:!1},uploadPlaceholderText:{type:String,required:!1},onUpload:{type:Function,required:!0}},setup({readonly:e,src:t,setLink:r,onUpload:l,imageIcon:c,uploadButton:s,confirmButton:d,uploadPlaceholderText:g,className:y}){var b,m;const k=f(!1),h=f(),O=f((b=t.value)!=null?b:""),P=f(de()),_=f(((m=t.value)==null?void 0:m.length)!==0),u=o=>{const v=o.target.value;_.value=v.length!==0,O.value=v},w=o=>{var i,v;o.key==="Enter"&&r((v=(i=h.value)==null?void 0:i.value)!=null?v:"")},a=()=>{var o,i;r((i=(o=h.value)==null?void 0:o.value)!=null?i:"")},p=o=>{var i;const v=(i=o.target.files)==null?void 0:i[0];v&&l(v).then(I=>{I&&(r(I),_.value=!0)}).catch(I=>{console.error("An error occurred while uploading image"),console.error(I)})};return()=>n("div",{class:N("image-edit",y)},n(B,{icon:c,class:"image-icon"}),n("div",{class:N("link-importer",k.value&&"focus")},n("input",{ref:h,draggable:"true",onDragstart:o=>{o.preventDefault(),o.stopPropagation()},disabled:e.value,class:"link-input-area",value:O.value,onInput:u,onKeydown:w,onFocus:()=>k.value=!0,onBlur:()=>k.value=!1}),!_.value&&n("div",{class:"placeholder"},n("input",{disabled:e.value,class:"hidden",id:P.value,type:"file",accept:"image/*",onChange:p}),n("label",{class:"uploader",for:P.value},n(B,{icon:s})),n("span",{class:"text",onClick:()=>{var o;return(o=h.value)==null?void 0:o.focus()}},g))),O.value&&n("div",{class:"confirm",onClick:()=>a()},n(B,{icon:d})))}}),me=x({props:{src:{type:Object,required:!0},caption:{type:Object,required:!0},ratio:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setAttr:{type:Function,required:!0},config:{type:Object,required:!0}},setup({src:e,caption:t,ratio:r,readonly:l,setAttr:c,config:s}){var d;const g=f(),y=f(),b=f(!!((d=t.value)!=null&&d.length)),m=f(0),k=()=>{var a;const p=g.value;if(!p)return;const o=p.closest(".milkdown-image-block");if(!o)return;const i=o.getBoundingClientRect().width;if(!i)return;const v=p.height,I=p.width,$=I<i?v:i*(v/I),F=($*((a=r.value)!=null?a:1)).toFixed(2);p.dataset.origin=$.toFixed(2),p.dataset.height=F,p.style.height=`${F}px`},h=a=>{a.preventDefault(),a.stopPropagation(),!l.value&&(b.value=!b.value)},O=a=>{const o=a.target.value;m.value&&window.clearTimeout(m.value),m.value=window.setTimeout(()=>{c("caption",o)},1e3)},P=a=>{const o=a.target.value;m.value&&(window.clearTimeout(m.value),m.value=0),c("caption",o)},_=a=>{a.preventDefault();const p=g.value;if(!p)return;const o=p.getBoundingClientRect().top,i=a.clientY-o,v=Number(i<100?100:i).toFixed(2);p.dataset.height=v,p.style.height=`${v}px`},u=()=>{window.removeEventListener("pointermove",_),window.removeEventListener("pointerup",u);const a=g.value;if(!a)return;const p=Number(a.dataset.origin),o=Number(a.dataset.height),i=Number.parseFloat(Number(o/p).toFixed(2));Number.isNaN(i)||c("ratio",i)},w=a=>{l.value||(a.preventDefault(),a.stopPropagation(),window.addEventListener("pointermove",_),window.addEventListener("pointerup",u))};return()=>n(Q,null,n("div",{class:"image-wrapper"},n("div",{class:"operation"},n("div",{class:"operation-item",onPointerdown:h},n(B,{icon:s.captionIcon()}))),n("img",{ref:g,"data-type":q,onLoad:k,src:e.value,alt:t.value}),n("div",{ref:y,class:"image-resize-handle",onPointerdown:w})),b.value&&n("input",{draggable:"true",onDragstart:a=>{a.preventDefault(),a.stopPropagation()},class:"caption-input",placeholder:s==null?void 0:s.captionPlaceholderText,onInput:O,onBlur:P,value:t.value}))}});var ve=Object.defineProperty,H=Object.getOwnPropertySymbols,fe=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable,M=(e,t,r)=>t in e?ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ye=(e,t)=>{for(var r in t||(t={}))fe.call(t,r)&&M(e,r,t[r]);if(H)for(var r of H(t))he.call(t,r)&&M(e,r,t[r]);return e};const be=x({props:{src:{type:Object,required:!0},caption:{type:Object,required:!0},ratio:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setAttr:{type:Function,required:!0},config:{type:Object,required:!0}},setup(e){const{src:t}=e;return()=>{var r;return(r=t.value)!=null&&r.length?n(me,ye({},e)):n(ge,{src:e.src,selected:e.selected,readonly:e.readonly,setLink:l=>e.setAttr("src",l),imageIcon:e.config.imageIcon(),uploadButton:e.config.uploadButton(),confirmButton:e.config.confirmButton(),uploadPlaceholderText:e.config.uploadPlaceholderText,onUpload:e.config.onUpload})}}}),U=G(E.node,e=>(t,r,l)=>{const c=f(t.attrs.src),s=f(t.attrs.caption),d=f(t.attrs.ratio),g=f(!1),y=f(!r.editable),b=(u,w)=>{const a=l();a!=null&&r.dispatch(r.state.tr.setNodeAttribute(a,u,u==="src"?D.sanitize(w):w))},m=e.get(j.key),k=K(be,{src:c,caption:s,ratio:d,selected:g,readonly:y,setAttr:b,config:m}),h=document.createElement("div");h.className="milkdown-image-block",k.mount(h);const O=J(()=>{g.value?h.classList.add("selected"):h.classList.remove("selected")}),P=m.proxyDomURL,_=u=>{if(!P)c.value=u.attrs.src;else{const w=P(u.attrs.src);typeof w=="string"?c.value=w:w.then(a=>{c.value=a}).catch(console.error)}d.value=u.attrs.ratio,s.value=u.attrs.caption,y.value=!r.editable};return _(t),{dom:h,update:u=>u.type!==t.type?!1:(_(u),!0),stopEvent:u=>u.target instanceof HTMLInputElement,selectNode:()=>{g.value=!0},deselectNode:()=>{g.value=!1},destroy:()=>{O(),k.unmount(),h.remove()}}});C(U,{displayName:"NodeView<image-block>",group:"ImageBlock"});const ke=[L,E,U,j].flat(),Oe=`
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
  >
    <g clip-path="url(#clip0_977_8075)">
      <path
        d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM14.14 11.86L11.14 15.73L9 13.14L6 17H18L14.14 11.86Z"
      />
    </g>
    <defs>
      <clipPath id="clip0_977_8075">
        <rect width="24" height="24" />
      </clipPath>
    </defs>
  </svg>
`;export{j as a,ke as b,te as c,E as d,Oe as i};
