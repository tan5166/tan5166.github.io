import{P as x,d as E,k as z,F as O,S as V,T as k,N as M,D,b as T,c as v,$ as F,e as S,f as W,M as p}from"./index-Ch0y_Xfo.js";function K(s={}){return new x({view(e){return new X(e,s)}})}class X{constructor(e,r){var o;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(o=r.width)!==null&&o!==void 0?o:1,this.color=r.color===!1?void 0:r.color||"black",this.class=r.class,this.handlers=["dragover","dragend","drop","dragleave"].map(t=>{let i=n=>{this[t](n)};return e.dom.addEventListener(t,i),{name:t,handler:i}})}destroy(){this.handlers.forEach(({name:e,handler:r})=>this.editorView.dom.removeEventListener(e,r))}update(e,r){this.cursorPos!=null&&r.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),r=!e.parent.inlineContent,o,t=this.editorView.dom,i=t.getBoundingClientRect(),n=i.width/t.offsetWidth,a=i.height/t.offsetHeight;if(r){let c=e.nodeBefore,h=e.nodeAfter;if(c||h){let m=this.editorView.nodeDOM(this.cursorPos-(c?c.nodeSize:0));if(m){let g=m.getBoundingClientRect(),y=c?g.bottom:g.top;c&&h&&(y=(y+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let P=this.width/2*a;o={left:g.left,right:g.right,top:y-P,bottom:y+P}}}}if(!o){let c=this.editorView.coordsAtPos(this.cursorPos),h=this.width/2*n;o={left:c.left-h,right:c.left+h,top:c.top,bottom:c.bottom}}let l=this.editorView.dom.offsetParent;this.element||(this.element=l.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",r),this.element.classList.toggle("prosemirror-dropcursor-inline",!r);let u,f;if(!l||l==document.body&&getComputedStyle(l).position=="static")u=-pageXOffset,f=-pageYOffset;else{let c=l.getBoundingClientRect(),h=c.width/l.offsetWidth,m=c.height/l.offsetHeight;u=c.left-l.scrollLeft*h,f=c.top-l.scrollTop*m}this.element.style.left=(o.left-u)/n+"px",this.element.style.top=(o.top-f)/a+"px",this.element.style.width=(o.right-o.left)/n+"px",this.element.style.height=(o.bottom-o.top)/a+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let r=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),o=r&&r.inside>=0&&this.editorView.state.doc.nodeAt(r.inside),t=o&&o.type.spec.disableDropCursor,i=typeof t=="function"?t(this.editorView,r,e):t;if(r&&!i){let n=r.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=E(this.editorView.state.doc,n,this.editorView.dragging.slice);a!=null&&(n=a)}this.setCursor(n),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}class d extends v{constructor(e){super(e,e)}map(e,r){let o=e.resolve(r.map(this.head));return d.valid(o)?new d(o):v.near(o)}content(){return V.empty}eq(e){return e instanceof d&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,r){if(typeof r.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new d(e.resolve(r.pos))}getBookmark(){return new A(this.anchor)}static valid(e){let r=e.parent;if(r.isTextblock||!Y(e)||!j(e))return!1;let o=r.type.spec.allowGapCursor;if(o!=null)return o;let t=r.contentMatchAt(e.index()).defaultType;return t&&t.isTextblock}static findGapCursorFrom(e,r,o=!1){e:for(;;){if(!o&&d.valid(e))return e;let t=e.pos,i=null;for(let n=e.depth;;n--){let a=e.node(n);if(r>0?e.indexAfter(n)<a.childCount:e.index(n)>0){i=a.child(r>0?e.indexAfter(n):e.index(n)-1);break}else if(n==0)return null;t+=r;let l=e.doc.resolve(t);if(d.valid(l))return l}for(;;){let n=r>0?i.firstChild:i.lastChild;if(!n){if(i.isAtom&&!i.isText&&!M.isSelectable(i)){e=e.doc.resolve(t+i.nodeSize*r),o=!1;continue e}break}i=n,t+=r;let a=e.doc.resolve(t);if(d.valid(a))return a}return null}}}d.prototype.visible=!1;d.findFrom=d.findGapCursorFrom;v.jsonID("gapcursor",d);class A{constructor(e){this.pos=e}map(e){return new A(e.map(this.pos))}resolve(e){let r=e.resolve(this.pos);return d.valid(r)?new d(r):v.near(r)}}function Y(s){for(let e=s.depth;e>=0;e--){let r=s.index(e),o=s.node(e);if(r==0){if(o.type.spec.isolating)return!0;continue}for(let t=o.child(r-1);;t=t.lastChild){if(t.childCount==0&&!t.inlineContent||t.isAtom||t.type.spec.isolating)return!0;if(t.inlineContent)return!1}}return!0}function j(s){for(let e=s.depth;e>=0;e--){let r=s.indexAfter(e),o=s.node(e);if(r==o.childCount){if(o.type.spec.isolating)return!0;continue}for(let t=o.child(r);;t=t.firstChild){if(t.childCount==0&&!t.inlineContent||t.isAtom||t.type.spec.isolating)return!0;if(t.inlineContent)return!1}}return!0}function H(){return new x({props:{decorations:U,createSelectionBetween(s,e,r){return e.pos==r.pos&&d.valid(r)?new d(r):null},handleClick:J,handleKeyDown:I,handleDOMEvents:{beforeinput:q}}})}const I=z({ArrowLeft:C("horiz",-1),ArrowRight:C("horiz",1),ArrowUp:C("vert",-1),ArrowDown:C("vert",1)});function C(s,e){const r=s=="vert"?e>0?"down":"up":e>0?"right":"left";return function(o,t,i){let n=o.selection,a=e>0?n.$to:n.$from,l=n.empty;if(n instanceof k){if(!i.endOfTextblock(r)||a.depth==0)return!1;l=!1,a=o.doc.resolve(e>0?a.after():a.before())}let u=d.findGapCursorFrom(a,e,l);return u?(t&&t(o.tr.setSelection(new d(u))),!0):!1}}function J(s,e,r){if(!s||!s.editable)return!1;let o=s.state.doc.resolve(e);if(!d.valid(o))return!1;let t=s.posAtCoords({left:r.clientX,top:r.clientY});return t&&t.inside>-1&&M.isSelectable(s.state.doc.nodeAt(t.inside))?!1:(s.dispatch(s.state.tr.setSelection(new d(o))),!0)}function q(s,e){if(e.inputType!="insertCompositionText"||!(s.state.selection instanceof d))return!1;let{$from:r}=s.state.selection,o=r.parent.contentMatchAt(r.index()).findWrapping(s.state.schema.nodes.text);if(!o)return!1;let t=O.empty;for(let n=o.length-1;n>=0;n--)t=O.from(o[n].createAndFill(null,t));let i=s.state.tr.replace(r.pos,r.pos,new V(t,0,0));return i.setSelection(k.near(i.doc.resolve(r.pos+1))),s.dispatch(i),!1}function U(s){if(!(s.selection instanceof d))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",D.create(s.doc,[T.widget(s.selection.head,e,{key:"gapcursor"})])}function R(s,e){return Object.assign(s,{meta:{package:"@milkdown/plugin-cursor",...e}}),s}const w=F({},"dropCursorConfig");R(w,{displayName:"Ctx<dropCursor>"});const L=S(s=>K(s.get(w.key)));R(L,{displayName:"Prose<dropCursor>"});const B=S(()=>H());R(B,{displayName:"Prose<gapCursor>"});const $=[w,L,B];function G(s){var e;const r=(e=void 0)!=null?e:!1;let o=typeof document>"u"?null:document.createElement("div");return new x({key:Q,view:t=>{r!==!0&&te(t.state.schema,r||[]);const i=t.dom.ownerDocument;o=o||document.createElement("div");const n=o,a=()=>{_(t,n)};let l;return window.ResizeObserver&&(l=new window.ResizeObserver(()=>a()),l.observe(t.dom)),i.addEventListener("selectionchange",a),{update:()=>{a()},destroy:()=>{i.removeEventListener("selectionchange",a),l&&l.unobserve(t.dom)}}},props:{handleKeyDown:(t,i)=>{var n;const{selection:a}=t.state;if(i.altKey||i.ctrlKey||i.metaKey||i.shiftKey||i.isComposing||!["ArrowLeft","ArrowRight"].includes(i.key)||!b(a)||!a.empty)return!1;const l=a.$head,[u,f]=N(l),c=t.state.storedMarks||l.marks();if(u&&f&&!p.sameSet(u,f)){if(i.key==="ArrowLeft"&&!p.sameSet(u,c))return t.dispatch(t.state.tr.setStoredMarks(u)),!0;if(i.key==="ArrowRight"&&!p.sameSet(f,c))return t.dispatch(t.state.tr.setStoredMarks(f)),!0}return i.key==="ArrowLeft"&&l.textOffset===1?(t.dispatch(t.state.tr.setSelection(k.create(t.state.doc,l.pos-1)).setStoredMarks(l.marks())),!0):i.key==="ArrowRight"&&l.textOffset+1===((n=l.parent.maybeChild(l.index()))==null?void 0:n.nodeSize)?(t.dispatch(t.state.tr.setSelection(k.create(t.state.doc,l.pos+1)).setStoredMarks(l.marks())),!0):!1},decorations:t=>{if(!(!o||!b(t.selection)||!t.selection.empty))return D.create(t.doc,[T.widget(0,o,{key:"prosemirror-virtual-cursor"})])},attributes:{class:"virtual-cursor-enabled"}}})}var Q=new W("prosemirror-virtual-cursor");function Z(s,e){var r;const o=window.getSelection();if(!o||!o.rangeCount)return null;const t=(r=o==null?void 0:o.getRangeAt(0))==null?void 0:r.cloneRange();if(!t)return null;t.collapse(e);const i=t.getClientRects(),n=i!=null&&i.length?i[i.length-1]:null;return n!=null&&n.height?n:s.coordsAtPos(s.state.selection.head)}function N(s){const e=s.index(),r=s.parent.maybeChild(e);let o=s.textOffset?r:null;return!o&&e>0&&(o=s.parent.maybeChild(e-1)),[o==null?void 0:o.marks,r==null?void 0:r.marks]}function b(s){return s&&typeof s=="object"&&"$cursor"in s}function _(s,e){if(!s||!s.dom||s.isDestroyed||!e)return;const{state:r,dom:o}=s,{selection:t}=r;if(!b(t))return;const i=Z(s,t.$head===t.$from);if(!i)return e;const n=o.getBoundingClientRect();let a="prosemirror-virtual-cursor";const l=r.selection.$head,[u,f]=N(l),c=r.storedMarks||l.marks();t.$cursor&&u&&f&&c&&!p.sameSet(u,f)&&(p.sameSet(u,c)?a+=" prosemirror-virtual-cursor-left":p.sameSet(f,c)&&(a+=" prosemirror-virtual-cursor-right")),e.className=a,ee(e,"prosemirror-virtual-cursor-animation"),e.style.height=`${i.bottom-i.top}px`,e.style.left=`${i.left-n.left}px`,e.style.top=`${i.top-n.top}px`}function ee(s,e){s.classList.remove(e),s.offsetWidth,s.classList.add(e)}function te(s,e){for(const[r,o]of Object.entries(s.marks))o.spec.inclusive===!1&&!e.includes(r)&&console.warn(`[prosemirror-virtual-cursor] Virtual cursor does not work well with marks that have inclusive set to false. Please consider removing the inclusive option from the "${r}" mark or adding it to the "skipWarning" option.`)}const oe=(s,e)=>{if(s.config(o=>{o.update(w.key,()=>{var t,i;return{class:"crepe-drop-cursor",width:(t=e==null?void 0:e.width)!=null?t:4,color:(i=e==null?void 0:e.color)!=null?i:!1}})}).use($),(e==null?void 0:e.virtual)===!1)return;const r=G();s.use(S(()=>r))};export{oe as defineFeature};
