import{m as B,k as K,a as Q}from"./inline-latex-C9IGAXXQ-DWrffwu3.js";import{a9 as y,aa as j,ab as _,ac as F,r as tt,C as et,A as W,ad as R,x as X,ae as nt,af as at,G as rt,N as it,ag as ot,ah as ut,ai as lt,aj as st,ak as V,al as ht}from"./index-Ch0y_Xfo.js";import{c as ct}from"./confirm-DtE-HkVd-CQtly_A8.js";import{s as O,c as mt,d as dt,h as $}from"./purify.es-CuyYui_p.js";import{O as pt}from"./index-DtS2etU_.js";import{t as wt,T as xt}from"./index-CwF23TQK.js";import{I as ft}from"./index-SF0jcbH_.js";import"./floating-ui.dom-DJfcjnnZ.js";import"./index-DiyBWuwY.js";function kt(){return{enter:{mathFlow:t,mathFlowFenceMeta:e,mathText:l},exit:{mathFlow:a,mathFlowFence:n,mathFlowFenceMeta:r,mathFlowValue:c,mathText:s,mathTextData:c}};function t(o){const h={type:"element",tagName:"code",properties:{className:["language-math","math-display"]},children:[]};this.enter({type:"math",meta:null,value:"",data:{hName:"pre",hChildren:[h]}},o)}function e(){this.buffer()}function r(){const o=this.resume(),h=this.stack[this.stack.length-1];y(h.type==="math"),h.meta=o}function n(){this.data.mathFlowInside||(this.buffer(),this.data.mathFlowInside=!0)}function a(o){const h=this.resume().replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),m=this.stack[this.stack.length-1];y(m.type==="math"),this.exit(o),m.value=h;const d=m.data.hChildren[0];y(d.type==="element"),y(d.tagName==="code"),d.children.push({type:"text",value:h}),this.data.mathFlowInside=void 0}function l(o){this.enter({type:"inlineMath",value:"",data:{hName:"code",hProperties:{className:["language-math","math-inline"]},hChildren:[]}},o),this.buffer()}function s(o){const h=this.resume(),m=this.stack[this.stack.length-1];y(m.type==="inlineMath"),this.exit(o),m.value=h,m.data.hChildren.push({type:"text",value:h})}function c(o){this.config.enter.data.call(this,o),this.config.exit.data.call(this,o)}}function gt(t){let e=(t||{}).singleDollarTextMath;return e==null&&(e=!0),n.peek=a,{unsafe:[{character:"\r",inConstruct:"mathFlowMeta"},{character:`
`,inConstruct:"mathFlowMeta"},{character:"$",after:e?void 0:"\\$",inConstruct:"phrasing"},{character:"$",inConstruct:"mathFlowMeta"},{atBreak:!0,character:"$",after:"\\$"}],handlers:{math:r,inlineMath:n}};function r(l,s,c,o){const h=l.value||"",m=c.createTracker(o),d="$".repeat(Math.max(j(h,"$")+1,2)),f=c.enter("mathFlow");let w=m.move(d);if(l.meta){const x=c.enter("mathFlowMeta");w+=m.move(c.safe(l.meta,{after:`
`,before:w,encode:["$"],...m.current()})),x()}return w+=m.move(`
`),h&&(w+=m.move(h+`
`)),w+=m.move(d),f(),w}function n(l,s,c){let o=l.value||"",h=1;for(e||h++;new RegExp("(^|[^$])"+"\\$".repeat(h)+"([^$]|$)").test(o);)h++;const m="$".repeat(h);/[^ \r\n]/.test(o)&&(/^[ \r\n]/.test(o)&&/[ \r\n]$/.test(o)||/^\$|\$$/.test(o))&&(o=" "+o+" ");let d=-1;for(;++d<c.unsafe.length;){const f=c.unsafe[d];if(!f.atBreak)continue;const w=c.compilePattern(f);let x;for(;x=w.exec(o);){let u=x.index;o.codePointAt(u)===10&&o.codePointAt(u-1)===13&&u--,o=o.slice(0,u)+" "+o.slice(x.index+1)}}return m+o+m}function a(){return"$"}}const Mt={tokenize:Ft,concrete:!0,name:"mathFlow"},D={tokenize:vt,partial:!0};function Ft(t,e,r){const n=this,a=n.events[n.events.length-1],l=a&&a[1].type==="linePrefix"?a[2].sliceSerialize(a[1],!0).length:0;let s=0;return c;function c(i){return t.enter("mathFlow"),t.enter("mathFlowFence"),t.enter("mathFlowFenceSequence"),o(i)}function o(i){return i===36?(t.consume(i),s++,o):s<2?r(i):(t.exit("mathFlowFenceSequence"),_(t,h,"whitespace")(i))}function h(i){return i===null||F(i)?d(i):(t.enter("mathFlowFenceMeta"),t.enter("chunkString",{contentType:"string"}),m(i))}function m(i){return i===null||F(i)?(t.exit("chunkString"),t.exit("mathFlowFenceMeta"),d(i)):i===36?r(i):(t.consume(i),m)}function d(i){return t.exit("mathFlowFence"),n.interrupt?e(i):t.attempt(D,f,S)(i)}function f(i){return t.attempt({tokenize:U,partial:!0},S,w)(i)}function w(i){return(l?_(t,x,"linePrefix",l+1):x)(i)}function x(i){return i===null?S(i):F(i)?t.attempt(D,f,S)(i):(t.enter("mathFlowValue"),u(i))}function u(i){return i===null||F(i)?(t.exit("mathFlowValue"),x(i)):(t.consume(i),u)}function S(i){return t.exit("mathFlow"),e(i)}function U(i,Y,L){let P=0;return _(i,Z,"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4);function Z(k){return i.enter("mathFlowFence"),i.enter("mathFlowFenceSequence"),N(k)}function N(k){return k===36?(P++,i.consume(k),N):P<s?L(k):(i.exit("mathFlowFenceSequence"),_(i,J,"whitespace")(k))}function J(k){return k===null||F(k)?(i.exit("mathFlowFence"),Y(k)):L(k)}}}function vt(t,e,r){const n=this;return a;function a(s){return s===null?e(s):(t.enter("lineEnding"),t.consume(s),t.exit("lineEnding"),l)}function l(s){return n.parser.lazy[n.now().line]?r(s):e(s)}}function yt(t){let r=(t||{}).singleDollarTextMath;return r==null&&(r=!0),{tokenize:n,resolve:Ct,previous:Tt,name:"mathText"};function n(a,l,s){let c=0,o,h;return m;function m(u){return a.enter("mathText"),a.enter("mathTextSequence"),d(u)}function d(u){return u===36?(a.consume(u),c++,d):c<2&&!r?s(u):(a.exit("mathTextSequence"),f(u))}function f(u){return u===null?s(u):u===36?(h=a.enter("mathTextSequence"),o=0,x(u)):u===32?(a.enter("space"),a.consume(u),a.exit("space"),f):F(u)?(a.enter("lineEnding"),a.consume(u),a.exit("lineEnding"),f):(a.enter("mathTextData"),w(u))}function w(u){return u===null||u===32||u===36||F(u)?(a.exit("mathTextData"),f(u)):(a.consume(u),w)}function x(u){return u===36?(a.consume(u),o++,x):o===c?(a.exit("mathTextSequence"),a.exit("mathText"),l(u)):(h.type="mathTextData",w(u))}}}function Ct(t){let e=t.length-4,r=3,n,a;if((t[r][1].type==="lineEnding"||t[r][1].type==="space")&&(t[e][1].type==="lineEnding"||t[e][1].type==="space")){for(n=r;++n<e;)if(t[n][1].type==="mathTextData"){t[e][1].type="mathTextPadding",t[r][1].type="mathTextPadding",r+=2,e-=2;break}}for(n=r-1,e++;++n<=e;)a===void 0?n!==e&&t[n][1].type!=="lineEnding"&&(a=n):(n===e||t[n][1].type==="lineEnding")&&(t[a][1].type="mathTextData",n!==a+2&&(t[a][1].end=t[n-1][1].end,t.splice(a+2,n-a-2),e-=n-a-2,n=a+2),a=void 0);return t}function Tt(t){return t!==36||this.events[this.events.length-1][1].type==="characterEscape"}function Et(t){return{flow:{36:Mt},text:{36:yt(t)}}}const St={};function _t(t){const e=this,r=t||St,n=e.data(),a=n.micromarkExtensions||(n.micromarkExtensions=[]),l=n.fromMarkdownExtensions||(n.fromMarkdownExtensions=[]),s=n.toMarkdownExtensions||(n.toMarkdownExtensions=[]);a.push(Et(r)),l.push(kt()),s.push(gt(r))}const $t=X.extendSchema(t=>e=>{const r=t(e);return{...r,toMarkdown:{match:r.toMarkdown.match,runner:(n,a)=>{var l,s;if(((l=a.attrs.language)!=null?l:"").toLowerCase()==="latex")n.addNode("math",void 0,((s=a.content.firstChild)==null?void 0:s.text)||"");else return r.toMarkdown.runner(n,a)}}}}),A=wt("INLINE_LATEX"),bt=dt({props:{config:{type:Object,required:!0},innerView:{type:Object,required:!0},updateValue:{type:Object,required:!0}},setup(t){const e=n=>{if(!(!n||!(n instanceof HTMLElement))){for(;n.firstChild;)n.removeChild(n.firstChild);t.innerView.value&&n.appendChild(t.innerView.value.dom)}},r=n=>{n.preventDefault(),t.updateValue.value()};return()=>{var n,a;return $("div",{class:"container"},t.innerView&&$("div",{ref:e}),$("button",{onPointerdown:r},$(ft,{icon:(a=(n=t.config).inlineEditConfirm)==null?void 0:a.call(n)})))}}});var G=t=>{throw TypeError(t)},H=(t,e,r)=>e.has(t)||G("Cannot "+r),p=(t,e,r)=>(H(t,e,"read from private field"),r?r.call(t):e.get(t)),g=(t,e,r)=>e.has(t)?G("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),b=(t,e,r,n)=>(H(t,e,"write to private field"),e.set(t,r),r),C,v,q,M,T,E,z,I;class qt{constructor(e,r,n){this.ctx=e,g(this,C),g(this,v),g(this,q),g(this,M,O(null)),g(this,T,O(()=>{})),g(this,E),g(this,z,()=>{p(this,M).value&&(p(this,M).value.destroy(),p(this,M).value=null)}),g(this,I,l=>{const c=(()=>{const{selection:o,schema:h}=l.state;if(o.empty||!(o instanceof it))return!1;const m=o.node;if(m.type.name!==Q)return!1;const d=o.from,f=h.nodes.paragraph.create(null,h.text(m.attrs.value)),w=new ot(p(this,q),{state:ut.create({doc:f,schema:new st({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p"}],toDOM(){return["p",0]}},text:{group:"inline"}}}),plugins:[lt({"Mod-z":ht,"Mod-Z":V,"Mod-y":V,Enter:()=>(p(this,T).value(),!0)})]})});return p(this,M).value=w,p(this,T).value=()=>{const{tr:x}=l.state;x.setNodeAttribute(d,"value",w.state.doc.textContent),l.dispatch(x),requestAnimationFrame(()=>{l.focus()})},!0})();return c||p(this,z).call(this),c}),this.update=(l,s)=>{p(this,v).update(l,s)},this.destroy=()=>{p(this,E).unmount(),p(this,v).destroy(),p(this,C).remove()};const a=document.createElement("div");a.className="milkdown-latex-inline-edit",b(this,C,a),b(this,E,mt(bt,{config:n,innerView:p(this,M),updateValue:p(this,T)})),p(this,E).mount(a),b(this,v,new xt({debounce:0,content:p(this,C),shouldShow:p(this,I),offset:10,floatingUIOptions:{placement:"bottom"}})),p(this,v).update(r),b(this,q,document.createElement("div"))}}C=new WeakMap;v=new WeakMap;q=new WeakMap;M=new WeakMap;T=new WeakMap;E=new WeakMap;z=new WeakMap;I=new WeakMap;const zt=R(t=>nt(/(?:\$)([^$]+)(?:\$)$/,B.type(t),{getAttr:e=>{var r;return{value:(r=e[1])!=null?r:""}}})),It=R(t=>at(/^\$\$[\s\n]$/,X.type(t),()=>({language:"LaTeX"}))),Lt=W("remarkMath",()=>_t);function Pt(t){return rt(t,"math",(e,r,n)=>{const{value:a}=e,l={type:"code",lang:"LaTeX",value:a};n.children.splice(r,1,l)})}const Nt=W("remarkMathBlock",()=>()=>Pt),Ut=(t,e)=>{t.config(r=>{if(!r.get(tt).includes(et.CodeMirror))throw new Error("You need to enable CodeMirror to use LaTeX feature");r.update(pt.key,l=>({...l,renderPreview:(s,c)=>{if(s.toLowerCase()==="latex"&&c.length>0)return Vt(c,e==null?void 0:e.katexOptions);const o=l.renderPreview;return o(s,c)}})),r.set(A.key,{view:l=>{var s;return new qt(r,l,{inlineEditConfirm:(s=e==null?void 0:e.inlineEditConfirm)!=null?s:()=>ct,...e})}})}).use(Lt).use(Nt).use(B).use(A).use(zt).use(It).use($t)};function Vt(t,e){return K.renderToString(t,{...e,throwOnError:!1,displayMode:!0})}export{Ut as defineFeature};
